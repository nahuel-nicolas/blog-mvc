version: "3.8"
services:
  postgres:
    image: postgres:14.4-alpine
    network_mode: "host"
    restart: unless-stopped
    environment:
      POSTGRES_HOST_AUTH_METHOD: "trust"
    volumes:
      - ./model/model_data:/var/lib/postgresql/data

  django_model:
    image: nahuelbarbieri/blog-app-mvc-django-model
    build:
      context: ./model/django_model/
      dockerfile: Dockerfile
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./model/django_model:/django_model
    command: >
      sh -c "cd /django_model &&
            echo '>>> INSTALLING PYTHON MODULES <<<' &&
            echo '' &&
            pip install -r requirements.txt &&
            echo '' &&
            echo '>>> RUNNING MIGRATIONS <<<' &&
            echo '' &&
            python manage.py migrate &&
            echo '' &&
            echo '>>> STARTING SERVICE <<<' &&
            echo '' &&
            python manage.py runserver"
    depends_on:
      - postgres

  redis:
    image: redis:7.0.5-alpine
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./controller/redis_data:/data

  node_controller:
    image: node:18.12.1-alpine3.15
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./controller/node_controller:/node_controller
    command: >
      sh -c "cd /node_controller &&
            echo '>>> INSTALLING NODE MODULES <<<' &&
            echo '' &&
            npm i &&
            echo '' &&
            echo '>>> STARTING SERVICE <<<' &&
            echo '' &&
            npm start"
    depends_on:
      - django_model
      - redis

  react_view:
    image: node:18.12.1-alpine3.15
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./view/react_view:/react_view
    command: >
      sh -c "cd /react_view &&
            echo '>>> INSTALLING NODE MODULES <<<' &&
            echo '' &&
            npm i &&
            echo '' &&
            echo '>>> STARTING SERVICE <<<' &&
            echo '' &&
            npm start"
    
    depends_on:
      - node_controller

  angular_view:
    image: node:18.12.1-alpine3.15
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./view/angular_view:/angular_view
    command: >
      sh -c "cd /angular_view &&
            echo '>>> INSTALLING NODE MODULES <<<' &&
            echo '' &&
            npm i &&
            echo '' &&
            echo '>>> STARTING SERVICE <<<' &&
            echo '' &&
            npm start"
    
    depends_on:
      - node_controller

  next_view:
    image: node:18.12.1-alpine3.15
    network_mode: "host"
    restart: unless-stopped
    volumes:
      - ./view/next_view:/next_view
    command: >
      sh -c "cd /next_view &&
            echo '>>> INSTALLING NODE MODULES <<<' &&
            echo '' &&
            npm i &&
            echo '' &&
            echo '>>> STARTING SERVICE <<<' &&
            echo '' &&
            npm run dev"
    
    depends_on:
      - node_controller